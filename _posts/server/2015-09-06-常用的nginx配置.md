---
layout: post
category : server
tagline: ""
tags : [nginx, server]
---
{% include JB/setup %}

### å‰è¨€

è™½ç„¶è¯´ä½œä¸ºä¸€ä¸ªå‰ç«¯æ”»åŸå¸ˆä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸ä¼šæ‹…å¿ƒnginxçš„ç›¸å…³é…ç½®çš„ï¼Œå¦‚æœæœ‰è¿ç»´åŒå­¦çš„è¯ï¼Œä¸€èˆ¬æ˜¯æ‰¾ä»–ä»¬å¸®å¿™æå®šè¿™äº›äº‹æƒ…çš„ã€‚ä½†æ˜¯å°ä¸€ç‚¹çš„å…¬å¸çš„è¯å¯èƒ½å°±æ ¹æœ¬æ²¡æœ‰è¿ç»´äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦â€œè‡ªå·±åŠ¨æ‰‹ï¼Œä¸°è¡£è¶³é£Ÿâ€äº†ï¼

### nginxç®€ä»‹

Nginxï¼ˆå‘éŸ³åŒengine xï¼‰æ˜¯ä¸€æ¬¾ç”±ä¿„ç½—æ–¯ç¨‹åºå‘˜Igor Sysoevæ‰€å¼€å‘è½»é‡çº§çš„ç½‘é¡µæœåŠ¡å™¨ã€åå‘ä»£ç†æœåŠ¡å™¨ä»¥åŠç”µå­é‚®ä»¶ï¼ˆIMAP/POP3ï¼‰ä»£ç†æœåŠ¡å™¨ã€‚ç”±äºå…¶å„ç§ä¼˜åŠ¿å„ç§å¥½ï¼ˆè‡ªè¡Œäº†è§£ï¼‰ï¼Œæ‰€ä»¥å¾ˆçƒ­å¾ˆç«ğŸ”¥ï¼ŒåŸºæœ¬ä¸Šå¤§å¤§å°å°çš„å…¬å¸éƒ½åœ¨ä½¿ç”¨äº†ã€‚

ä»¥å‰çš„å‰ç«¯å¯èƒ½ä¸ä¼šæ¶‰åŠåˆ°è¿™æ–¹é¢ï¼Œä½†æ˜¯ç”±äº[node.js](nodejs.org)ç«çˆ†ä¹‹åï¼Œå‰ç«¯ä»¥åŠå‘æ‰€è°“çš„â€œå…¨æ ˆâ€æ–¹å‘è½¬ç§»äº†ï¼Œç„¶ååŸºäºnode.jsçš„å„ç§å·¥ç¨‹ã€å·¥å…·ä¹Ÿæ˜¯è¶Šæ¥è¶Šå¤šã€‚è¿™æ—¶å€™å‰ç«¯éœ€è¦çš„è¶Šæ¥è¶Šå¤šäº†ï¼Œè€Œnginxä¼¼ä¹æˆä¸ºäº†â€œåˆšéœ€â€ï¼ˆå¯¹è‡ªå·±è€Œè¨€ï¼‰ï¼Œè™½ç„¶ä¸éœ€è¦æ·±å…¥çš„äº†è§£nginxä»€ä¹ˆåŸç†å•Šä»€ä¹ˆæœºåˆ¶å•Šï¼Œä½†æ˜¯æœ€åŸºç¡€çš„è¿˜æ˜¯éœ€è¦çš„ï¼Œæœ€èµ·ç æœ€èµ·ç ä¼šåšä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œæ»¡è¶³è‡ªå·±çš„æ—¥å¸¸éœ€è¦ã€‚


### åŸºç¡€é…ç½®

é¦–å…ˆï¼Œæœ€åŸºç¡€çš„è«è¿‡äºé…ç½®ä¸€ä¸ªserverï¼Œç„¶åæŒ‡å‘è‡ªå·±é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œä»¥ä¾¿èƒ½é€šè¿‡åŸŸåæˆ–è€…ipè®¿é—®ã€‚ä¸‹è¾¹çœ‹ä¸€ä¸ªæœ€åŸºç¡€ç‰ˆæœ¬çš„å¼€å‘ç¯å¢ƒé…ç½®ï¼š

```
# nginx.conf
http {
	include       mime.types;
	default_type  application/octet-stream;

	log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
					  '$status $body_bytes_sent "$http_referer" '
					  '"$http_user_agent" "$http_x_forwarded_for"';

	access_log  logs/access.log  main;

	sendfile        on;
	#tcp_nopush     on;

	keepalive_timeout  65;
		
	gzip  on;
	autoindex on; #æ–‡ä»¶åˆ—è¡¨
	autoindex_exact_size off;
	autoindex_localtime on;
		
	# å¼€å¯ssiæ”¯æŒï¼Œé»˜è®¤æ˜¯off
	ssi on;
	# é»˜è®¤å€¼æ˜¯offï¼Œå¼€å¯ååœ¨å¤„ç†SSIæ–‡ä»¶å‡ºé”™æ—¶ä¸è¾“å‡ºé”™è¯¯æç¤º:â€[an error occurred while processing the directive] â€
	ssi_silent_errors on;
	# é»˜è®¤æ˜¯text/htmlï¼Œå¦‚æœéœ€è¦shtmlæ”¯æŒï¼Œåˆ™éœ€è¦è®¾ç½®ï¼šssi_types text/shtml
	ssi_types text/shtml;

	expires -1;
	if_modified_since off;
	add_header Last-Modified "";
	add_header Etag "";

	add_header Access-Control-Allow-Origin *;# å…è®¸ä»»ä½•åŸŸ
	add_header Access-Control-Allow-Headers X-Requested-With;
	add_header Access-Control-Allow-Methods GET,POST,OPTIONS;

	server {
		listen       80;
		server_name  localhost;

		#access_log  logs/host.access.log  main;

		location / {
			root   /git/;
			index  index.html index.htm;
		}

		#error_page  404              /404.html;

		# redirect server error pages to the static page /50x.html
		#
		error_page   500 502 503 504  /50x.html;
		location = /50x.html {
			root   html;
		}
	}

	server {
		listen 80;
		server_name fed.com;
		location / {
			root   /git/fed/;
		}
	}
}
```

<!--more-->

ä¸Šè¾¹å…¶å®å°±æ˜¯nginxä½œä¸ºåŸºæœ¬çš„æ–‡ä»¶æœåŠ¡çš„åŸºæœ¬é…ç½®ï¼Œæ„æ€å°±æ˜¯å¯åŠ¨äº†ä¸¤ä¸ªserverï¼Œä¸€ä¸ªæ˜¯`localhost`ä¸€ä¸ª`fed.com`ï¼Œè®°å¾—éœ€è¦åœ¨æœ¬æœºhostsä¸­åŠ å…¥`127.0.0.1 fed.com`ï¼›ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—®`localhost`çš„è¯ï¼Œæ˜¾ç¤ºçš„å†…å®¹å°±æ˜¯æœ¬æœºçš„`/git/`ç›®å½•ä¸‹çš„å†…å®¹ï¼Œè€Œè®¿é—®`fed.com`çš„è¯åˆ™ä¼šæ˜¾ç¤ºæœ¬æœº`/git/fed/`ä¸‹çš„å†…å®¹ã€‚

nginxæ˜¯æ”¯æŒincludeè¯­æ³•çš„ï¼Œæ‰€ä»¥åœ¨ä¸€èˆ¬åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šé’ˆå¯¹äºä¸åŒçš„server_nameåˆ›å»ºä¸åŒçš„`.conf`æ–‡ä»¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯åœ¨nginxé…ç½®ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªå­æ–‡ä»¶å¤¹`conf.d`ï¼Œç„¶ååªéœ€è¦åœ¨`http`é…ç½®ä¸­çš„æœ€ååŠ ä¸Š`include /usr/local/etc/nginx/conf.d/*.conf;`å°±OKäº†ï¼Œä¹Ÿå°±æ˜¯ï¼š

```
http {
	include /path/to/nginx/conf.d/*.conf;
}
```

ç„¶åä¸Šè¾¹çš„`fed.com`å°±å¯ä»¥å•ç‹¬æ‹¿å‡ºæ¥äº†ï¼Œå¯ä»¥æŠŠå®ƒå‘½åä¸º`fed.com.conf`ï¼Œç„¶åå†è¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹å°±æ˜¯ä¸Šè¾¹é…ç½®ä¿¡æ¯ï¼š

```
server {
	listen 80;
	server_name fed.com;
	location / {
		root   /git/fed/;
	}
}
```

æœ‰å¥½å¤šæ—¶å€™å¼€å‘ç¯å¢ƒæ˜¯éœ€è¦åå‘ä»£ç†çš„ï¼Œè¿™ä¸ªé€šè¿‡nginxæ˜¯å¾ˆå®¹æ˜“å°±åšåˆ°çš„ï¼Œå¦‚ä¸‹ï¼š

```
server {
	listen 80;
	server_name dev.example.com dev2.example.com; #é…ç½®å¤šä¸ªname
	
	location / {
		proxy_pass http://127.0.0.1:3000;
		proxy_redirect     off;
		proxy_set_header   Host             $host;
		# ä¸‹è¾¹ä¿©ä¸ªé…ç½®çš„ä»‹ç»
		# http://gong1208.iteye.com/blog/1559835
		# http://bbs.linuxtone.org/thread-9050-1-1.html
		proxy_set_header   X-Real-IP        $remote_addr;
		proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
		client_max_body_size       10m;
	}
}
```

åœ¨æµè§ˆå™¨ä¸­è®¿é—®`dev.example.com`æˆ–è€…`dev2.example.com`å¯ä»¥çœ‹åˆ°å…¶å®æ˜¯ä»£ç†åˆ°äº†æœ¬æœºç›‘å¬`3000`ç«¯å£çš„æœåŠ¡ä¸Šå»äº†ã€‚

### è´Ÿè½½å‡è¡¡

å¦‚æœç½‘ç«™æµé‡ç›¸å¯¹æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œä¸€å°serverå·²ç»æ»¡è¶³ä¸äº†éœ€æ±‚äº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½éœ€è¦åŠ ä¸Šè´Ÿè½½å‡è¡¡äº†ï¼Œnginxä¸­åŒæ ·ä¹Ÿæä¾›äº†æ–¹æ³•ï¼š

```
upstream back-server {
	# PS: åœ°å€çç¼–çš„
	server 123.56.67.110:8000 weight 2;
	server 123.56.67.111:8000 weight=1 max_fails=2 fail_timeout=30s ;
	server 123.56.67.112:8090 backup;
}
server {
	listen 80;
	location / {
		proxy_pass http://back-server;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
	}
}
```

ç®€å•è¯´ä¸‹ä¸Šè¾¹é…ç½®çš„æ„æ€ï¼Œnginxé»˜è®¤æ”¯æŒçš„è°ƒåº¦ç®—æ³•æ˜¯`è½®è¯¢`ï¼ˆè‡ªå¸¦çš„è¿˜æœ‰ä¸€ä¸ª`ip_hash`è°ƒåº¦ç®—æ³•ï¼ŒæŒ‰ç…§è®¿é—®ipçš„hashç»“æœåˆ†é…ï¼‰ï¼š

> æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æŸå°æœåŠ¡å™¨å®•æœºï¼Œæ•…éšœç³»ç»Ÿè¢«è‡ªåŠ¨å‰”é™¤ï¼Œä½¿ç”¨æˆ·è®¿é—®ä¸å—å½±å“ã€‚Weight æŒ‡å®šè½®è¯¢æƒå€¼ï¼ŒWeightå€¼è¶Šå¤§ï¼Œåˆ†é…åˆ°çš„è®¿é—®æœºç‡è¶Šé«˜ï¼Œä¸»è¦ç”¨äºåç«¯æ¯ä¸ªæœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µä¸‹ã€‚

é™¤å»`weight`çš„å€¼ï¼Œå…¶ä»–å­—æ®µæ„æ€åˆ†åˆ«æ˜¯ï¼š

* `max_fails`: å…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼›è¶…è¿‡åè¿”å›`proxy_next_upstream`æ¨¡å—å®šä¹‰çš„é”™è¯¯ã€‚

* `fail_timeout`: æœ‰ä¸¤å±‚å«ä¹‰ï¼Œä¸€æ˜¯åœ¨æŒ‡å®šæ—¶é—´å†…æœ€å¤šå¯ä»¥æœ‰`max_fails`æ¬¡å¤±è´¥ï¼›è¿˜æœ‰å°±æ˜¯åœ¨`max_fails`æ¬¡å¤±è´¥åï¼Œåœ¨è¯¥æŒ‡å®šæ—¶é—´å†…ä¸åˆ†é…è¯·æ±‚åˆ°è¿™å°serverã€‚

* `backup`: é¢„ç•™æœºå™¨ï¼Œå½“å…¶ä»–æœºå™¨éƒ½ä¸æ­£å¸¸çš„æ—¶å€™å°±ä¼šè®¿é—®åˆ°è¿™å°serveräº†ã€‚

* `proxy_next_upstream`: è¯¥æŒ‡ä»¤å±äº`http_proxy`æ¨¡å—ï¼ŒæŒ‡å®šåç«¯è¿”å›ä»€ä¹ˆæ ·çš„å¼‚å¸¸å“åº”æ—¶ï¼Œä½¿ç”¨å…¶ä»–server

### åœºæ™¯è®°

è¿™é‡Œå†ç®€è¦ä»‹ç»ä¸‹ä¸€äº›åœºæ™¯ä¸‹çš„é…ç½®ã€‚

#### æ”¯æŒHTML5çš„pushstate

è¿™ç§åœºæ™¯å¾ˆç®€å•ï¼Œå°±æ˜¯å•é¡µé¢çš„åœºæ™¯ï¼Œä½†æ˜¯åˆå¸Œæœ›ä½¿ç”¨çš„ä¸æ˜¯hashæ¥æ”¹å˜æµè§ˆå™¨åœ°å€ï¼Œè€Œæ˜¯é€šè¿‡HTML5çš„`pushstate`æ¥æ”¹å˜åœ°å€ï¼›å¦‚æœæ­¤æ—¶æˆ‘ä»¬åç«¯æ²¡æœ‰serveråªæ˜¯é™æ€htmlæ–‡ä»¶çš„è¯ï¼Œä¸€æ—¦åˆ·æ–°å°±ä¼š404äº†ã€‚

åœ¨nginxä¸­ï¼Œæˆ‘ä»¬é€šè¿‡`rewrite`æŒ‡ä»¤æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼š

```
server {
	server_name myserver.com;
	location / {
		root /git/myproject/;
		rewrite ^/(.*)$ /index.html break;
	}
}
```

å¦‚æœè¯´æˆ‘ä»¬ä¸å¸Œæœ›æ‰€æœ‰çš„åœ°å€éƒ½rewriteåˆ°index.htmlï¼Œä¾‹å¦‚åœ¨é¡¹ç›®ä¸­è¿˜æœ‰jsã€cssç­‰ç›®å½•çš„æ—¶å€™ï¼Œæ­¤æ—¶éœ€è¦çš„å°±æ˜¯è¿”å›å¯¹åº”çš„jsã€cssç­‰æ–‡ä»¶äº†ã€‚é‚£ä¹ˆåªéœ€è¦ç¨åŠ ä¿®æ”¹å°±å¯ä»¥äº†ï¼š

```
server {
	server_name myserver.com;
	location / {
		root /git/myproject/;
		rewrite ^/(?!js|css).*$ /index.html break;
	}
}
```

`rewrite`çš„è¯­æ³•å°±æ˜¯ï¼š

	rewrite regex replacement [flag];

å¯ä»¥çœ‹åˆ°åè¾¹ç´§è·Ÿçš„åˆ†åˆ«æ˜¯ï¼šä¸€ä¸ªæ­£åˆ™ã€ç¬¦åˆæ­£åˆ™çš„æ›¿æ¢ä¸ºçš„å­—ç¬¦ä¸²å€¼ã€æœ€åæ˜¯ä¸€ä¸ªå¯çœç•¥çš„`flag`æ ‡è®°ã€‚

`flag`å¯ä»¥æœ‰å¦‚ä¸‹å€¼ï¼š

* `last`: ç›¸å½“äºApacheçš„[L]æ ‡è®°ï¼Œè¡¨ç¤ºå®Œæˆrewriteï¼Œä¼šåœæ­¢rewriteæ£€æµ‹ï¼Œä½†æ˜¯è·Ÿbreakæœ‰æœ¬è´¨çš„ä¸åŒï¼Œlastçš„è¯­å¥ä¸ä¸€å®šæ˜¯æœ€ç»ˆç»“æœ 

* `break`: æœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆåï¼Œç»ˆæ­¢åŒ¹é…ï¼Œä¸å†åŒ¹é…åé¢çš„è§„åˆ™ï¼Œä¼šåœæ­¢rewriteæ£€æµ‹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å«æœ‰break flagçš„rewriteè¯­å¥è¢«æ‰§è¡Œæ—¶ï¼Œè¯¥è¯­å¥å°±æ˜¯rewriteçš„æœ€ç»ˆç»“æœ

* `redirect`: è¿”å›302ä¸´æ—¶é‡å®šå‘ï¼Œæµè§ˆå™¨åœ°å€ä¼šæ˜¾ç¤ºä¸ºè·³è½¬åçš„URL

* `permanent`: è¿”å›301æ°¸ä¹…é‡å®šå‘ï¼Œæµè§ˆå™¨åœ°å€ä¼šæ˜¾ç¤ºä¸ºè·³è½¬åçš„URL

è¿™é‡Œæ¯”è¾ƒéš¾ç†è§£çš„æ˜¯`last`å’Œ`rewrite`çš„åŒºåˆ«äº†ï¼Œè¿™é‡Œåªéœ€è¦ç®€å•è®°ä½ï¼š`last`ä¸€èˆ¬å†™åœ¨serverå’Œifä¸­ï¼Œè€Œ`break`åˆ™ä¸€èˆ¬å†™åœ¨`location`ä¸­å°±å¯ä»¥äº†ã€‚

#### æŸä¸ªpathä¸‹çš„è®¿é—®çš„å†…å®¹éœ€è¦é‡æ–°å®šä¹‰

è¿™é‡Œçš„é‡æ–°å®šä¹‰ä¸€èˆ¬åŒ…å«ä¸¤ç§æƒ…å†µï¼š

1. è®¿é—®åˆ°å…¶ä»–ç›®å½•ï¼ˆæ–‡ä»¶æœåŠ¡ï¼‰

1. è®¿é—®å…¶ä»–serverï¼ˆä¸€èˆ¬åå‘ä»£ç†æœåŠ¡ï¼‰

##### è®¿é—®åˆ°å…¶ä»–ç›®å½•

å‡è®¾è®¿é—®staticè·¯å¾„ä¸‹çš„å†…å®¹çš„æ—¶å€™ï¼Œå…¶å®æ˜¯å¸Œæœ›ä»å¦ä¸€ç›®å½•å¾—åˆ°çš„ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±éœ€è¦é‡æ–°é…ç½®äº†ï¼š

```
server {
	listen 80;
	server_name fed.com;
	location / {
		root   /git/fed/;
	}

	location /static/ {
		root   /git/static/;
		break;
	}
}
```

ä¸Šè¾¹çš„é…ç½®çš„ç»“æœå°±æ˜¯è®¿é—®`fed.com/static/*`çš„å†…å®¹çš„æ—¶å€™å…¶å®è¿”å›çš„æ˜¯ç›®å½•`/git/static/static/*`çš„å†…å®¹ã€‚

æ³¨æ„ä¸Šè¾¹çš„ç»“æœæ˜¯`/git/static/static/*`ï¼Œè€Œä¸æ˜¯`/git/static/*`ï¼Œè¿™æ˜¯å¾ˆå€¼å¾—æ³¨æ„çš„ä¸€ç‚¹ã€‚å…¶å®è¿™ä¹Ÿå°±æ˜¯æ¶‰åŠåˆ°äº†`root`å’Œ`alias`æŒ‡ä»¤çš„åŒºåˆ«äº†ï¼Œå¦‚æœæ”¹æˆä¸‹è¾¹çš„ï¼š

```
server {
	listen 80;
	server_name fed.com;
	location / {
		root   /git/fed/;
	}

	location /static/ {
		alias   /git/static/;
		break;
	}
}
```

é‚£ä¹ˆè®¿é—®`fed.com/static/*`ä¸‹çš„å†…å®¹çš„è¯å°±æ˜¯è¿”å›çš„`/git/static/*`çš„å†…å®¹äº†ã€‚

##### è®¿é—®å…¶ä»–server

ä¾‹å¦‚è®¿é—®`/api/`ä¸‹çš„å°±ç»Ÿä¸€å‘é€åˆ°åç«¯çš„æ¥å£æœåŠ¡ä¸Šå»çš„è¯ï¼Œå¯ä»¥è¿™æ ·é…ç½®ï¼š

```
server {
	listen 80;
	server_name fed.com;
	location / {
		root   /git/fed/;
	}

	location /api/ {
		proxy_pass http://server.com;
	  proxy_set_header Host $host;
	}
}
```

è¿™æ ·è®¿é—®`/api/*`çš„è¯å°±ä¼šä»£ç†åˆ°`http://server.com`æœåŠ¡ä¸Šäº†ã€‚

å‚è€ƒï¼š

1. <http://nginx.org/en/docs/>
1. <https://zh.wikipedia.org/wiki/Nginx>
1. <http://tengine.taobao.org/book/index.html>
1. <http://iqbon.iteye.com/blog/1882319>
1. <http://segmentfault.com/a/1190000002873747>
1. <http://gong1208.iteye.com/blog/1559835>
1. <http://bbs.linuxtone.org/thread-9050-1-1.html>
1. <http://segmentfault.com/a/1190000002873747>
1. <http://saiyaren.iteye.com/blog/1914865>
1. <http://readystate4.com/2012/05/17/nginx-and-apache-rewrite-to-support-html5-pushstate/>
1. <<http://segmentfault.com/a/1190000002797606>>
1. <http://blog.cafeneko.info/2010/10/nginx_rewrite_note/>
